var TF_Gallery_Manager=function(){function e(e){this.widget=e,this.dz_element=this.widget.querySelector(".tf-gallery-dz"),this.dz=null,this.token=Joomla.getOptions("csrf.token"),this.dropzone_message=this.dz_element.querySelector(".dz-message");e=parseInt(this.dz_element.dataset.maxfiles),this.max_files=e||null,e=parseFloat(this.dz_element.dataset.maxfilesize);this.max_file_size=e||null,this.baseurl=this.dz_element.dataset.baseurl,this.rooturl=this.dz_element.dataset.rooturl,this.upload_url="index.php?option=com_ajax&format=raw&plugin=Widgets&widget=GalleryManager",this.item_id=0,this.is_media_uploader_file=!1,this.media_uploader_filename="",this.actions_dropdown_class=".tf-gallery-actions-dropdown",Dropzone.autoDiscover=!1,this.initSortable(),this.detectJ3MediaUploaderImage(),this.initEvents(),this.dz_element.GalleryManager=this}var t=e.prototype;return t.initSortable=function(){this.widget.classList.contains("readonly")||this.widget.classList.contains("disabled")||this.widget.classList.contains("ordering-default")&&new Sortable(this.dz_element,{animation:150,handle:".dz-thumb"})},t.initEvents=function(){this.widget.addEventListener("click",function(e){this.onEditItemOpenModal(e),this.onSaveEditedItem(e),this.onRemovalOfSelectedImages(e),this.onSelectUnselectAllImages(e),this.onJ4MediaManagerSelection(e),this.onRegenerateImages(e)}.bind(this)),this.widget.addEventListener("dblclick",function(e){this.onDoubleClickSelectItem(e)}.bind(this)),this.widget.addEventListener("change",function(e){this.selectItem(e)}.bind(this))},t.onEditItemOpenModal=function(e){var t=e.target.closest(".tf-gallery-preview-edit-item");if(t){e.preventDefault();var e=this.dz_element.dataset.rooturl,i=t.closest(".nrf-widget.tf-gallery-manager").querySelector(".tf-gallery-manager-edit-modal-content"),t=t.closest(".tf-gallery-preview-item"),s=t.dataset.itemId,s=(i.querySelector('input[type="hidden"].item_id').value=s,i.querySelector("img").src=e+t.querySelector("input.item-original").value,t.querySelector("textarea.item-alt").value),e=(i.querySelector('input[type="text"][name="alt"]').value=s,t.querySelector("input.item-caption").value);if(i.querySelector('textarea[name="caption"]').value=e,window.Joomla.Modal){var l=i.querySelector("joomla-field-fancy-select").choicesInstance,s=(l.removeActiveItems(),l._store.choices),e=(l.setChoices(s,"value","label",!0),t.querySelector("input.item-tags").value||"[]");(e=JSON.parse(e)||[]).length&&e.forEach(function(e){l.setChoiceByValue(e+"")})}else{var a=i.querySelector('select[name="tags[]"]'),n=a.options.length;if(n){for(var r=0;r<n;r++)a.options[r].selected=!1;jQuery(a).trigger("liszt:updated")}s=t.querySelector("input.item-tags").value||"[]";(s=JSON.parse(s)||[]).length&&(s.forEach(function(e){jQuery(a).find('option[value="'+e+'"]').prop("selected",!0)}),jQuery(a).trigger("liszt:updated"))}}},t.onSaveEditedItem=function(e){var t,i,e=e.target.closest(".tf-gallery-button-save-edited-item");e&&(i=(e=e.closest(".nrf-widget.tf-gallery-manager").querySelector(".tf-gallery-manager-edit-modal-content")).querySelector('input[type="hidden"].item_id').value,t=this.widget.querySelector('.tf-gallery-preview-item[data-item-id="'+i+'"]'),i=e.querySelector('input[type="text"][name="alt"]').value,t.querySelector("textarea.item-alt").value=i,i=e.querySelector('textarea[name="caption"]').value,t.querySelector('input[type="hidden"].item-caption').value=i,i="",i=window.Joomla.Modal?e.querySelector("joomla-field-fancy-select").choicesInstance.getValue(!0):jQuery(e.querySelector('select[name="tags[]"]')).chosen().val(),t.querySelector('input[type="hidden"].item-tags').value=JSON.stringify(i),t.classList.add("is-edited-animation"),setTimeout(function(){t.classList.remove("is-edited-animation")},1300))},t.lazyLoadThumbs=function(){var s,t,l=this;window.IntersectionObserver&&(s=this.dz_element.dataset.rooturl,t=new IntersectionObserver(function(e,i){e.forEach(function(e){var t;e.isIntersecting&&(t=s+e.target.closest(".tf-gallery-preview-item").querySelector(".item-thumbnail").value,l.loadThumbnail(e.target.closest(".tf-gallery-preview-item"),t),i.unobserve(e.target))})},{rootMargin:"0px 0px 0px 0px"}),this.dz_element.querySelectorAll("img:not([src])").forEach(function(e){t.observe(e)}))},t.init=function(){var s=this,e=!!this.widget.querySelector(':scope > input[type="hidden"]');this.dz=new Dropzone(this.dz_element,{url:this.baseurl+this.upload_url,previewTemplate:this.dz_element.nextElementSibling.innerHTML,clickable:[this.dz_element,this.widget.querySelector(".tf-gallery-add-item-button")],maxFilesize:this.max_file_size,uploadMultiple:!0,maxFiles:this.max_files,acceptedFiles:this.dz_element.dataset.acceptedfiles,autoProcessQueue:!0,parallelUploads:1,filesizeBase:2048,createImageThumbnails:!0,dictRemoveFileConfirmation:Joomla.JText._("NR_GALLERY_MANAGER_CONFIRM_DELETE"),thumbnailHeight:220,thumbnailWidth:300,timeout:0,init:function(){this.on("addedfile",function(e){0!==this.files.length&&s.markNotClickable(this),s.previewMessageHide(),s.onAddedFile(e),s.max_files===this.files.length&&s.disableAddButton()}),s.handleMocks(this),this.on("sending",function(e,t,i){s.onSendingFile(i)}),this.on("success",function(e){s.onSuccessUploadFile(e)}),this.on("removedfile",function(e){s.onRemovedFile(e)}),this.on("error",function(e,t,i){s.onErrorFile(e,t,i)}),this.on("queuecomplete",function(e){s.widget.classList.remove("dz-working")}),e&&(s.determineFieldValidityAndToggleValidatorField(this.files),this.on("removedfile",function(){s.determineFieldValidityAndToggleValidatorField(this.files)}),this.on("complete",function(){s.determineFieldValidityAndToggleValidatorField(this.files)}))}}),this.lazyLoadThumbs()},t.determineFieldValidityAndToggleValidatorField=function(e){e=e.some(function(e){return"success"==e.status||e.exists});this.toggleHiddenValidatorField(e?"hide":"show")},t.toggleHiddenValidatorField=function(e){void 0===e&&(e="hide");var t=this.widget.querySelector(':scope > input[type="hidden"]');"hide"==e?(t.removeAttribute("required"),t.classList.remove("required")):(t.setAttribute("required","required"),t.classList.add("required"))},t.onAddedFile=function(e){var t;null==e.upload?(t={source:e.source,original:e.original,thumbnail:e.thumbnail,caption:e.caption,alt:e.alt,tags:e.tags,is_media_uploader_file:e.is_media_uploader_file},this.createHiddenInput(e.previewTemplate,t),e.error&&(e.previewTemplate.classList.add("dz-error"),(t=e.previewTemplate.querySelector(".tf-gallery-preview-error")).innerHTML=e.error,t.classList.add("visible"))):(this.widget.classList.add("dz-working"),e.previewTemplate.classList.add("new"),this.showItemInQueueMessage(e.previewTemplate))},t.handleMocks=function(e){if(t=this.dz_element.dataset.value){for(var t=JSON.parse(t),i=0;i<t.length;i++){var s=t[i];s.accepted=!0,s.exists||(s.error=Joomla.JText._("NR_GALLERY_MANAGER_FILE_MISSING")),e.emit("addedfile",s),e.emit("success",s),e.emit("complete",s),this.setThumbValue(e.element,s.thumb),e.files.push(s),0!==e.files.length&&this.markNotClickable(e)}this.max_files===t.length&&this.disableAddButton()}},t.markNotClickable=function(e){this.widget.classList.add("dz-has-items"),this.dz_element.classList.remove("dz-clickable"),this.dz_element.removeEventListener("click",e.listeners[1].events.click)},t.markClickable=function(){this.widget.classList.remove("dz-has-items"),this.dz_element.dataset.value="",this.dz.destroy(),this.init()},t.setThumbValue=function(e,t){t&&(e.querySelector("input.item-thumb").value=t)},t.onRemovedFile=function(e){var t;0==this.dz.files.length&&(this.markClickable(),this.resetSelectedUnselectAllButton(),this.previewMessageShow(),this.setIsEditing(!1)),this.dz.files.length<this.max_files&&this.enableAddButton(),0!=e.size&&0!=e.accepted&&e.original&&e.thumbnail&&((t=new XMLHttpRequest).onload=function(){200<=t.status&&t.status<300||alert(t.responseText)},t.open("POST",this.baseurl+this.upload_url),t.setRequestHeader("X-CSRF-Token",this.token),(fd=new FormData).append("task","delete"),fd.append("field_id",this.widget.dataset.fieldId),fd.append("source","source"in e&&e.source?e.source:e.previewElement.querySelector(".item-source").value),fd.append("original",e.original),fd.append("thumbnail",e.thumbnail),fd.append("is_media_uploader_file",void 0!==e.is_media_uploader_file&&e.is_media_uploader_file),t.send(fd))},t.onSendingFile=function(e){e.append("task","upload"),e.append("field_id",this.widget.dataset.fieldId),e.append(this.token,1),this.is_media_uploader_file&&(e.append("media_uploader",1),e.append("media_uploader_filename",this.media_uploader_filename),this.is_media_uploader_file=!1,this.media_uploader_filename="")},t.loadThumbnail=function(e,t){var i=this,s=new Image;s.onload=function(){i.setPreviewImageAspectRatio(e,this.width,this.height)},s.src=t,e.querySelector("img").src=t},t.setPreviewImageAspectRatio=function(e,t,i){t/=i;(t<.3||3<t)&&e.querySelector(".dz-thumb img").classList.add("fit-contain")},t.onSuccessUploadFile=function(e){var t=e.xhr.response;try{if(!(t=JSON.parse(t)).original||!t.thumbnail)throw"Cannot upload file";this.setPreviewImageAspectRatio(e.previewElement,e.width,e.height),e.source=t.source,e.original=t.original,e.thumbnail=t.thumbnail,this.createHiddenInput(e.previewTemplate,t),this.hideItemInQueueMessage(e.previewTemplate)}catch(e){alert("Error! "+e)}},t.onErrorFile=function(e,t,i){this.hideItemInQueueMessage(e.previewTemplate),e.thumbnail=e.upload.uuid,e.previewTemplate.querySelector(".item-thumbnail").value=e.upload.uuid,e.previewTemplate.querySelectorAll("*[name]").forEach(function(e){e.removeAttribute("name")})},t.previewMessageHide=function(){this.dropzone_message.classList.add("is-hidden")},t.previewMessageShow=function(){this.dropzone_message.classList.remove("is-hidden")},t.createHiddenInput=function(e,t){var i=document.createElement("input");e.classList.remove("template");var s=(s=this.dz_element.dataset.inputname).replace("ITEM_ID",this.item_id);i.setAttribute("name",s+"[image]"),i.setAttribute("class","item-original"),i.setAttribute("type","hidden"),i.setAttribute("value",t.original),e.appendChild(i),this.setElementItemID(e,"item-caption"),this.setCaption(e,t),this.setElementItemID(e,"select-item-checkbox input","id"),this.setElementItemID(e,"select-item-checkbox label","for"),this.setElementItemID(e,"item-thumbnail"),this.setThumbnailPath(e,t),this.setElementItemID(e,"item-source"),this.setSourcePath(e,t),this.setElementItemID(e,"item-alt"),this.setAltText(e,t),this.setElementItemID(e,"item-tags"),this.setItemTags(e,t),e.setAttribute("data-item-id",t.thumbnail),this.item_id++},t.setThumbnailPath=function(e,t){t.thumbnail&&(e.querySelector(".item-thumbnail").value=t.thumbnail)},t.setSourcePath=function(e,t){t.source&&(e.querySelector(".item-source").value=t.source)},t.setAltText=function(e,t){t.alt&&(e.querySelector(".item-alt").value=t.alt)},t.setCaption=function(e,t){t.caption&&(e.querySelector(".item-caption").value=t.caption)},t.setItemTags=function(e,t){t.tags&&(e.querySelector(".item-tags").value=t.tags)},t.setElementItemID=function(e,t,i){void 0===i&&(i="name");e=e.querySelector("."+t),t=e.getAttribute(i).replace("ITEM_ID",this.item_id);e.setAttribute(i,t)},t.dataURItoBlob=function(e){for(var t=atob(e.split(",")[1]),e=e.split(",")[0].split(":")[1].split(";")[0],i=new ArrayBuffer(t.length),s=new Uint8Array(i),l=0;l<t.length;l++)s[l]=t.charCodeAt(l);return new Blob([i],{type:e})},t.fileToDataURL=function(e,t){var i=new XMLHttpRequest;i.onload=function(){var e=new FileReader;e.onloadend=function(){t(e.result)},e.readAsDataURL(i.response)},i.open("GET",e),i.responseType="blob",i.send()},t.detectJ3MediaUploaderImage=function(){var s,l=this,e=(MutationObserver=window.MutationObserver||window.WebKitMutationObserver,this.widget.querySelector(".media_uploader_file"));s=e,new MutationObserver(function(e,t){if("value"==e[0].attributeName){if(!s.value)return!1;var e=s.value,i=l.rooturl+e;l.addFileByURL(i,e)}}).observe(s,{attributes:!0})},t.onJ4MediaManagerSelection=function(e){var t,i,s=e.target.closest(".tf-gallery-button-save-selected");s&&(s=s.closest(".nrf-widget.tf-gallery-manager"),t=this.widget.querySelector("iframe").contentDocument.querySelectorAll(".media-browser-items .media-browser-item.selected"))&&(e.preventDefault(),i=s.querySelector(".tf-gallery-dz"),t.forEach(function(e){var e=e.querySelector(".image-background .image-cropped"),e=(e.src||e.style.backgroundImage.match(/url\(["']?([^"']*)["']?\)/)[1]).split("?")[0],t="images"+e.split("/images")[1];i.GalleryManager.addFileByURL(e,t)}))},t.onRegenerateImages=function(e){var t,s,i,l,a=e.target.closest(".tf-gallery-regenerate-images-button");a&&!e.target.closest(".message")&&confirm(Joomla.JText._("NR_GALLERY_MANAGER_CONFIRM_REGENERATE_IMAGES"))&&(e.preventDefault(),(t=this).widget.classList.add("dz-working"),a.classList.add("working"),e=this.widget.querySelectorAll(".tf-gallery-preview-item"),s=[],e.forEach(function(e){var t=e.querySelector('input[type="hidden"].item-source').value,i=e.querySelector('input[type="hidden"].item-original').value,e=e.querySelector('input[type="hidden"].item-thumbnail').value;s.push({source:t,original:i,thumbnail:e})}),i=a.querySelector(".message"),e=this.baseurl+this.upload_url+"&task=regenerate_images&"+this.token+"=1",(l=new FormData).append("item_id",this.widget.dataset.itemId),l.append("field_id",this.widget.dataset.fieldId),l.append("items",JSON.stringify(s)),fetch(e,{method:"POST",body:l}).then(function(e){return e.json()}).then(function(e){i.innerHTML=e.message,i.classList.add("visible"),setTimeout(function(){i.classList.remove("visible")},1500),a.classList.remove("working"),t.widget.classList.remove("dz-working"),t.updateMissingSourceImages(e.items)}).catch(function(e){alert(e)}))},t.updateMissingSourceImages=function(e){var t=this;e.forEach(function(e){t.widget.querySelector('.tf-gallery-preview-item[data-item-id="'+e.thumbnail+'"]').querySelector('input[type="hidden"].item-source').value=e.source})},t.onDoubleClickSelectItem=function(e){var e=e.target.closest(".tf-gallery-preview-item");e&&((e=e.querySelector('input[type="checkbox"]')).checked=!e.checked,e.dispatchEvent(new Event("change",{bubbles:!0})))},t.addFileByURL=function(i,s){var l=this,a=this.widget.querySelector(".media_uploader_file");this.fileToDataURL(i,function(e){var t=e.split(",")[0].match(/[^:\s*]\w+\/[\w-+\d.]+(?=[;| ])/)[0],e=l.dataURItoBlob(e,t);e.name=s,l.dz.addFile(e),l.is_media_uploader_file=!0,l.media_uploader_filename=i,a.value=""})},t.resetSelectedUnselectAllButton=function(){0==this.dz.files.length&&this.updateSelectButton("select",!0)},t.updateSelectButton=function(e,t){void 0===e&&(e="select"),void 0===t&&(t=!1);var i=this.widget.querySelector(".tf-gallery-actions "+this.actions_dropdown_class),s=i.querySelector(".tf-gallery-actions-dropdown-current"),l="icon-checkbox-checked",a="icon-checkbox-unchecked";"select"===e?(s.classList.remove("unselect"),s.classList.add("select")):(s.classList.remove("select"),s.classList.add("unselect"),e=a,a=l,l=e),s.querySelector("i").classList.remove(l),s.querySelector("i").classList.add(a),t&&i.setAttribute("disabled",!0)},t.onRemovalOfSelectedImages=function(e){var t=this,i=e.target.closest(".tf-gallery-remove-selected-items-button");if(i){e.preventDefault();var s,e=this.getAllItems(!0);if(0==e.length)return!1;confirm(Joomla.JText._("NR_GALLERY_MANAGER_CONFIRM_DELETE_ALL_SELECTED"))&&(i.setAttribute("disabled",!0),s=[],e.forEach(function(e){s.push(e.closest(".tf-gallery-preview-item").querySelector(".item-thumbnail").value)}),this.dz.files.filter(function(e){return s.includes(e.thumbnail)}).forEach(function(e){t.dz.removeFile(e)}),i.removeAttribute("disabled"),this.setIsEditing(!1),this.resetSelectedUnselectAllButton())}},t.selectItem=function(e){var t=e.target.closest(".select-item-checkbox");t&&(this.updateGalleryItem(t.querySelector('input[type="checkbox"]')),e.preventDefault())},t.setIsEditing=function(e){e?this.widget.classList.add("editing"):this.widget.classList.remove("editing")},t.updateGalleryItem=function(e){var t=this.getAllItems().length,i=this.getAllItems(!0).length;0<i?this.widget.querySelector(this.actions_dropdown_class+" .dropdown-menu li a.unselect").classList.remove("is-hidden"):(this.widget.querySelector(this.actions_dropdown_class+" .dropdown-menu li a.select").classList.remove("is-hidden"),this.widget.querySelector(this.actions_dropdown_class+" .dropdown-menu li a.unselect").classList.add("is-hidden"),this.updateSelectButton("select")),e.checked?(e.closest(".tf-gallery-preview-item").classList.add("is-selected"),this.setIsEditing(!0)):(e.closest(".tf-gallery-preview-item").classList.remove("is-selected"),0===i&&this.setIsEditing(!1)),t===i?(this.updateSelectButton("unselect"),this.widget.querySelector(this.actions_dropdown_class+" .dropdown-menu li a.select").classList.add("is-hidden")):(this.updateSelectButton("select"),this.widget.querySelector(this.actions_dropdown_class+" .dropdown-menu li a.select").classList.remove("is-hidden"))},t.onSelectUnselectAllImages=function(e){var t=e.target.closest(".tf-gallery-actions-dropdown-action");t&&(e.preventDefault(),0!==this.getAllItems().length)&&("unselect"==(e=t.classList.contains("unselect")?"select":"unselect")?this.selectAllImages():this.unselectAllImages(),this.updateSelectButton(e))},t.select=function(e){e=e.querySelector(".select-item-checkbox input:not(:checked)");e.checked=!0,e.dispatchEvent(new Event("change",{bubbles:!0})),this.updateGalleryItem(e)},t.deselect=function(e){e=e.querySelector(".select-item-checkbox input:checked");e.checked=!1,e.dispatchEvent(new Event("change",{bubbles:!0})),this.updateGalleryItem(e)},t.selectAllImages=function(){var t=this;this.widget.querySelectorAll(".tf-gallery-preview-item:not(.is-selected)").forEach(function(e){t.select(e)})},t.unselectAllImages=function(){var t=this;this.widget.querySelectorAll(".tf-gallery-preview-item.is-selected").forEach(function(e){t.deselect(e)})},t.getAllItems=function(e){return this.widget.querySelectorAll(".tf-gallery-preview-item .select-item-checkbox input"+((e=void 0===e?!1:e)?":checked":""))},t.showItemInQueueMessage=function(e){e.querySelector(".tf-gallery-preview-in-queue").classList.add("is-visible")},t.hideItemInQueueMessage=function(e){e.querySelector(".tf-gallery-preview-in-queue").classList.remove("is-visible")},t.getAddButtonWrapper=function(){return this.widget.querySelector(".tf-gallery-actions .add-button")},t.enableAddButton=function(){var e=this.getAddButtonWrapper();e.classList.remove("disabled"),e.removeAttribute("title")},t.disableAddButton=function(){var e=this.getAddButtonWrapper();e.classList.add("disabled"),e.title=Joomla.JText._("NR_GALLERY_MANAGER_REACHED_FILES_LIMIT")},t.getGalleryMediaManagerModal=function(){return document.querySelector("#tf-GalleryMediaManager")},e}();

